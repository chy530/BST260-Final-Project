---
title: "Final Project"
output: html_document
---

```{r setup, include=FALSE}
#reduce knitr figure size
knitr::opts_chunk$set(fig.width=6, fig.height=4) 
```

##Synopsis
This project examines economic trends in Major League Baseball. Data sources include the Lahman database (for salaries, performance, and other info), Baseball Reference (for Wins Above Replacement), Forbes (for financials), the US Census Bureau (for US household income), and the Bureau of Labor Statistics (for Consumer Price Index). The data exploration includes trends in player salary, team finances, team performance, and the relationship between salary/spending and player/team performance.

###Player Salaries

```{r,warning=FALSE,echo=FALSE,message=FALSE}
#load libraries
#load Lahman salary data
library(tidyverse)
library(gridExtra)
setwd("/Users/Chris/Dropbox/School Stuff/BST 260 Data Science/baseball2017")
salaries <- read.csv("Salaries.csv",stringsAsFactors=FALSE)
```
Note that salary information is only available from 1985 forward.
```{r}
min(salaries$yearID)
```

We can observe salary trends over time using player salary data from the Lahman dataset, and US household salary data.

```{r,warning=FALSE,echo=FALSE}
#summarize player salary data
#load US Census Bureau salary data
#combine salary data and plot
BBsalaries = salaries %>% group_by(yearID) %>% summarize(msalary=median(salary),avg=mean(salary), q25 = quantile(salary,0.25), q75 = quantile(salary,0.75), q90 = quantile(salary,0.9))
setwd("/Users/Chris/Dropbox/School Stuff/BST 260 Data Science/baseball2017")
USsalaries <- read.csv("USmedsalary.csv")
USsalaries <- USsalaries %>% filter(yearID > 1984)
USsalaries <- USsalaries[order(USsalaries$yearID),]

BBsalaries$BBpct <- BBsalaries$msalary/BBsalaries$msalary[[1]]
BBsalaries$BBavgpct <- BBsalaries$avg/BBsalaries$avg[[1]]
USsalaries$USpct <- USsalaries$msalary/USsalaries$msalary[[1]]
USsalaries$USavgpct <- USsalaries$avg/USsalaries$avg[[1]]

allsal <- merge(BBsalaries,USsalaries,by="yearID")

override.color <- c("red","red","blue","blue")
override.linetype <- c(1,2,1,2)

ggplot(allsal,aes(x=yearID)) + 
  geom_line(aes(y=USpct,color="US median",linetype="US median")) +
  geom_line(aes(y=USavgpct,color="US average",linetype="US average")) +
  geom_line(aes(y=BBpct,color="MLB median",linetype="MLB median")) +
  geom_line(aes(y=BBavgpct,color="MLB average",linetype="MLB average")) +
  scale_x_continuous(breaks = seq(1985,2015,5)) +
  scale_y_continuous(breaks = seq(0,10,1)) +
  labs(x="Year",y="Salary level vs 1985 (multiplier)",title="MLB salary vs US household income") +
  scale_color_manual(values = c("red","red","blue","blue")) +
  scale_linetype_manual(values = c(1,2,1,2)) +
  guides(color = guide_legend(override.aes = list(color = override.color, linetype = override.linetype),title="")) +
  guides(linetype=FALSE)

```

Using the respective 1985 salaries as a baseline, we see that US median household income has increased by around 25% every 5 years. Growth in median player salary has generally outpaced the salary growth of US households until the past decade. Average salary, in contrast, has increased at a greater rate since 1990. This suggests that salary trends for "top" players may be different from that of "typical" players. Let's see if this is true.

```{r,echo=FALSE}
#plot player salary trends for different percentiles
override.color <- c("red","red","seagreen3","blue")
override.linetype <- c(2,1,2,1)

ggplot(allsal,aes(x=yearID)) + 
  geom_line(aes(y=q25/1000000,color="25th",linetype="25th")) +
  geom_line(aes(y=msalary.x/1000000,color="50th",linetype="50th")) +
  geom_line(aes(y=q75/1000000,color="75th",linetype="75th")) +
  geom_line(aes(y=q90/1000000,color="90th",linetype="90th")) +
  scale_x_continuous(breaks = seq(1985,2015,5)) +
  scale_y_continuous(breaks = seq(0,15,2.5)) +
  labs(x="Year",y="Salary ($, millions)",title="MLB salary growth, percentiles") +
  scale_color_manual(values = c("red","red","seagreen3","blue")) +
  scale_linetype_manual(values = c(2,1,2,1)) +
  guides(color = guide_legend(override.aes = list(color = override.color, linetype = override.linetype),title="")) +
  guides(linetype=FALSE)
```

Observing the trends by percentile, we can see that, indeed, salaries have not increased at the same rate across the board, with large gains for the top paid players, with little change for players in the lower percentiles. We will now look at a comparison of percentiles by team.

```{r,echo=FALSE,warning=FALSE}
#group by teams
#plot salary trends for high earners versus median earners
salteam <- salaries %>% select(playerID,yearID,teamID,salary) %>% na.omit() %>% group_by(yearID,teamID) %>% summarize(totsal = sum(salary), avgsal = mean(salary), p50sal = quantile(salary,.5), p90sal = quantile(salary,.9), p90rat = quantile(salary,.9)/median(salary))

override.color = c("seagreen3","orangered1")
salteam %>% ggplot() + 
  geom_boxplot(aes(yearID,p50sal/1000000,factor=factor(yearID),color="50th"),outlier.shape=NA, na.rm = TRUE) +
  geom_boxplot(aes(yearID,p90sal/1000000,factor=factor(yearID),color="90th"),outlier.shape=NA, na.rm = TRUE) +
  scale_x_continuous(breaks = seq(1985,2015,5)) +
  scale_y_continuous(trans="log10") +
  scale_color_manual(values = c("seagreen3","orangered1")) +
  labs(x = "Year", y = "Salary ($, millions)", title = "Salaries across teams") +
  guides(color = guide_legend(override.aes = list(color = override.color),title="Percentile"))
```

On a team-by-team basis, we can see that salary growth was not the same between the median and the 90th salary percentiles. In particular, there was a decreasing trend in median salary between 1991 and 1995, where the 90th percentile did not change. What may have caused this?

```{r,echo=FALSE,warning=FALSE}
#replot previous data as ratio to show trend in relative salary
#show year of strike
salteam %>% ggplot(aes(yearID,p90rat,fill=factor(yearID))) + 
  geom_boxplot(na.rm = TRUE) + theme(legend.position="none") + 
  scale_x_continuous(breaks = seq(1985,2015,5)) +
  scale_y_continuous(breaks = seq(0,30,5)) +
  geom_vline(aes(xintercept=as.numeric(1994)),linetype=1,size=5,alpha=0.5, color="red") +
  geom_text(aes(x=1994,y=25),label="STRIKE",angle=90,hjust = 0,color="white") +
  labs(title="Ratio of 90th:50th percentile salaries",x="Year",y="90th percentile รท median salary")
```

Using the same data to plot the ratio of the 90th percentile salary to the median, we can see an increasing trend until 1995, the year after the baseball strike of 1994, then a decreasing trend afterwards. Again, percentiles were calculated by team. 

Is this a real trend? Let's check with a piecewise linear spline regression (2 methods).

```{r,echo=FALSE,message=FALSE,warning=FALSE}
#piecewise linear spline, 2 methods
library(splines)
splfit <- lm(p90rat ~ yearID + yearID*(yearID>1994.5),data=salteam)
summary(splfit)

library(segmented)
splfit2 <- lm(p90rat ~ yearID,data=salteam)
splmod <- segmented(splfit2, seg.Z = ~yearID, psi=1994)
summary(splmod)
```

Looks like there are different trends before and after the strike.
Modeling a discontinuous regression also illustrates this break.

```{r,,echo=FALSE,message=FALSE,warning=FALSE}
#create rdd model
library(rdd)
rddfit <- RDestimate(p90rat~yearID,data=salteam,cutpoint=1994.5)
summary(rddfit)
```

```{r,echo=FALSE}
#plot rdd fit
plot(rddfit)
```

###Team Revenues

Following the strike of 1994, a two-pronged plan was put in place to limit the effect of reduced revenues. First was to enact revenue-sharing in order to keep smaller teams from struggling financially. The other was a luxury tax, which was a way to limit the spending of the big teams without explicitly enforcing a salary cap.

Let's look at how team/franchise revenue has changed over time. Data comes from Michael Ozanian, a writer for Forbes, who has been compiling annual financial data for Major League Baseball since 1990. Numbers have been adjusted to 1990 dollars using the Consumer Price Index (CPI).

```{r,echo=FALSE,warning=FALSE}
setwd("/Users/Chris/Dropbox/School Stuff/BST 260 Data Science/baseball2017")
revs <- read.csv("MLBrevs.csv",stringsAsFactors=FALSE)
names <- read.csv("Teamnames.csv",stringsAsFactors=FALSE)
cpi <- read.csv("cpi.csv")

# Generate franchise ID for each team in "revs" data gathered from Forbes; accounts for team name changes and standardizes to Lahman franchise notation
revs$franchID = ""
for (i in 1:nrow(revs)){
  nameyear <- names %>% filter(yearID==revs$Year[[i]])
  nameab <- nameyear %>% filter(grepl(revs$Team[[i]],nameyear$name)==TRUE)
  revs$franchID[[i]] = nameab$franchID[[1]]
}

# Calculate inflation factor by year vs 1990 dollars (v1990)
cpi <- cpi %>% filter(year>1989)
cpi1990 = cpi$cpi[[1]]
cpi <- cpi %>% mutate(v1900 = cpi/cpi1990)
for (i in 1:nrow(revs)){
  revs$v1990[[i]] = cpi$v1900[which(cpi$year==revs$Year[[i]])]  
}

ggplot(revs) + geom_boxplot(aes(Year,Revenue/v1990,fill=factor(Year))) +
  geom_vline(aes(xintercept=as.numeric(1994)),linetype=1,size=5,alpha=0.5, color="red") +
  geom_text(aes(x=1994,y=200),label="STRIKE",angle=90,hjust = 0,color="white") +
  labs(title="Team revenues by year",x="Year",y="Revenue in 1990 dollars, millions") +
  scale_x_continuous(breaks = seq(1990,2015,5)) +
  scale_y_continuous(breaks = seq(0,300,50)) +
  theme(legend.position="none")
```

We see that there is a drop in revenues in the year of the stike, but this recovers after a few years. Note that the 2012 revenue data is incomplete and skewed upwards. What about franchise values?

```{r,echo=FALSE}
ggplot(revs) + geom_boxplot(aes(Year,Value/v1990,fill=factor(Year))) +
  geom_vline(aes(xintercept=as.numeric(1994)),linetype=1,size=5,alpha=0.5, color="red") +
  geom_text(aes(x=1994,y=500),label="STRIKE",angle=90,hjust = 0,color="white") +
  labs(title="Team values by year",x="Year",y="Valuation in 1990 dollars, log millions") +
  scale_x_continuous(breaks = seq(1990,2015,5)) +
  scale_y_continuous(breaks = c(125,250,500,1000,2000),trans="log10") +
  theme(legend.position="none")
```

We can see that the strike did not drastically affect franchise values. Soon after the strike, as revenues recovered, valuations rose greatly after the revenue sharing agreement, and again after 2010 (note that the 2012 valuation data is complete). Let's look back at revenues. How did revenues for each team change from year to year?

```{r,echo=FALSE}
revs <- revs[order(revs$franchID,revs$Year),]
revs$Value = as.numeric(revs$Value)

for (i in 2:nrow(revs)){
  if (revs$Year[[i]]>1990){
    revs$dvpct[[i]] = (revs$Value[[i]]-revs$Value[[i-1]])/revs$Value[[i-1]]
    revs$dv[[i]] = (revs$Value[[i]]-revs$Value[[i-1]])
    revs$dr[[i]] = (revs$Revenue[[i]]-revs$Revenue[[i-1]])/revs$Revenue[[i-1]]
    revs$di[[i]] = (revs$O_Income[[i]]-revs$O_Income[[i-1]])/revs$O_Income[[i-1]]
  }
}

revs %>% filter(Year > 1990) %>% ggplot() + geom_boxplot(aes(Year,dvpct,fill=factor(Year))) +
  geom_vline(aes(xintercept=as.numeric(1994)),linetype=1,size=7,alpha=0.5, color="red") +
  geom_text(aes(x=1994,y=-1),label="STRIKE",angle=90,hjust = 0,color="white") +
  labs(title="Annual changes in revenue",x="Year",y="Change in revenue ($, millions)") +
  scale_x_continuous(breaks = seq(1990,2015,5)) +
  #scale_y_continuous(breaks = c(125,250,500,1000,2000),trans="log10") +
  theme(legend.position="none")
```

We can see that teams mostly have increasing revenues year-on-year, with the biggest increases in 1997 and 2014. The other goal of the revenue sharing agreement was to prevent losses. Was this accomplished? We will look at this information over time, stratifying by Collective Bargaining Agreement (CBA), the contract between team owners that sets the financial rules of the league. 

```{r,echo=FALSE}
revs$deval <- ifelse(revs$dv<0,1,0)

base.plot <- ggplot() +
  scale_x_continuous(limits = c(1989,2016), breaks=seq(1990,2015,5)) +
  scale_fill_distiller(palette = "Spectral",breaks=seq(0,70,20),name="Percent") +
  geom_vline(aes(xintercept=1993.5),linetype=3, color="black") +
  geom_vline(aes(xintercept=1994.5),linetype=3, color="black") +
  geom_vline(aes(xintercept=2001.5),linetype=3, color="black") +
  geom_vline(aes(xintercept=2006.5),linetype=3, color="black") +
  geom_vline(aes(xintercept=2010.5),linetype=3, color="black")

revs$oloss <- ifelse(revs$O_Income<0,1,0)
oloss <- revs %>% group_by(Year) %>% summarize(teams = sum(oloss)/n())
oloss.plot <- base.plot + geom_bar(aes(Year,teams*100,fill=teams*100),stat="identity",data = oloss) + 
  theme(axis.title.x = element_blank(), axis.text.x = element_blank()) +
  scale_y_continuous(breaks=seq(0,80,10),limits=c(0,80)) + 
  geom_text(aes(x=1994,y=5),label="STRIKE",angle=90,hjust = 0,color="white") +
  geom_text(aes(x=1990.5,y=80),label="CBA7",hjust = 0,color="black",size=3.5) +
  geom_text(aes(x=1997,y=80),label="CBA8",hjust = 0,color="black",size=3.5) +
  geom_text(aes(x=2003,y=80),label="CBA9",hjust = 0,color="black",size=3.5) +
  geom_text(aes(x=2007.2,y=80),label="CBA10",hjust = 0,color="black",size=3.5) +
  geom_text(aes(x=2012,y=80),label="CBA11",hjust = 0,color="black",size=3.5) +
  labs(title="Operating losses and lost value",y="Teams with\noperating loss (%)")

deval <- revs %>% filter(Year>1990) %>% group_by(Year) %>% summarize(teams = sum(deval)/n())
deval.plot <- base.plot + geom_bar(aes(Year,teams*100,fill=teams*100),stat="identity",data=deval) +
  scale_y_continuous(breaks=seq(0,80,10)) +
  labs(y="Teams that \n lost value (%)")

grid.arrange(oloss.plot,deval.plot,ncol=1)
```

We see that the percentage of teams suffering either an operating loss or loss in franchiase value has decreased over time, particularly following the enactment of CBA10. Is this a real trend? Let's check.

```{r,echo=FALSE}
summary(lm(teams ~ Year,data=oloss))
summary(lm(teams ~ Year,data=deval))
```

The linear models suggest a decreasing trend, with the percentage of teams suffering operating/valuation loss decreasing by ~1.5% every year, for a ~30 percentage point decrease over 20 years (not using compounding). Let's look at differences between the different CBA periods.

```{r,echo=FALSE}
addcba <- function(df){
  df$cba = .bincode(df$Year,c(0,1993.5,1994.5,2002,2006,2010,10000))
  df$cba = ifelse(df$cba>2,df$cba+5,df$cba)
  df$cba = ifelse(df$cba==1,df$cba+6,df$cba)
  df$cba = ifelse(df$cba==2,NA,df$cba)
  df
}
oloss = addcba(oloss)
deval = addcba(deval)

anova.oloss <- aov(teams ~ as.factor(cba),data=oloss)
summary(anova.oloss)
TukeyHSD(anova.oloss)
anova.deval <-aov(teams ~ as.factor(cba),data=deval)
summary(anova.deval)
TukeyHSD(anova.deval)
```

The Tukey multiple comparisons show that valuation losses were highest during CBA7 and significantly lower for all periods thereafter. The period differences in operating losses are less clear, although CBA10 is significantly lower than CBA7 and CBA8.

sources:

https://www.sbnation.com/2010/8/30/1065675/8-30-2002-baseball-avoids-another
https://www.fangraphs.com/tht/a-history-of-the-collective-bargaining-agreement-part-3/

The analysis suggests that the measures taken in successive CBAs since the 1994 strike have improved the financial sitation of the league. Did this affect spending on players?

```{r,echo=FALSE,message=FALSE,warning=FALSE}
totsals <- salteam %>% group_by(yearID) %>% mutate(mutot = mean(totsal),sdtot = sd(totsal))
totsals <- totsals %>% mutate(stdtot = (totsal-mutot)/sdtot)
totsals %>% ggplot() + geom_point(aes(yearID,stdtot,group=yearID),size=1) +
  geom_smooth(aes(yearID,stdtot)) +
  labs(title="Standardized payrolls",x="Year",y="Std. total salary")

revsals <- revs %>% rename(yearID=Year)
revsals <- left_join(revsals,names,by=c("yearID","franchID"))
revsals <- left_join(revsals,totsals,by=c("yearID","teamID"))
revsals <- revsals %>% mutate(pctrev = totsal/(Revenue*1000000))
revsals %>% ggplot() + geom_boxplot(aes(yearID,pctrev,fill=factor(yearID))) +
  geom_vline(aes(xintercept=as.numeric(1994)),linetype=1,size=7,alpha=0.5, color="red") +
  geom_text(aes(x=1994,y=0.0),label="STRIKE",angle=90,hjust = 0,color="white") +
  labs(title="Percent of revenue spent on player payroll",x="Year",y="Percentage of revenue ($, millions)") +
  scale_x_continuous(breaks = seq(1990,2015,5)) +theme(legend.position="none")
```

We can see that the standardized distribution of payrolls across the league remained fairly consistent until after 2001, after which there was one team (the Yankees, obviously) with a much higher spend for several years.

Looking at percentage of revenue spent, it appears that player payrolls have been around 50% of franchise revenue for the past 20 years, with the exception of the strike year and year immediately following, where revenues took a hit.

###Performance

As a measure of player performance, we will use Wins Above Replacement (WAR). The calculation is very involved and not standardized, so the WAR numbers were taken from the Baseball Refernce database (not the same as the Lahman Database).

First, let's look at how WAR distribution across the league has changed over time.

```{r,echo=FALSE,eval=FALSE}
# Adds salary and other numbers to WAR (for batters) table
# This block saves code to a csv, which is saved in the project folder.
1 = 1 #prevents running accidentally since this takes a while to run

library(tidyverse)
setwd("/Users/Chris/Dropbox/School Stuff/BST 260 Data Science/baseball2017/war_archive-2017-11-08")
wars <- read.csv("war_daily_bat.csv",stringsAsFactors=FALSE)
setwd("/Users/Chris/Dropbox/School Stuff/BST 260 Data Science/baseball2017")
salaries <- read.csv("Salaries.csv",stringsAsFactors=FALSE)

salaries <- salaries %>% filter(yearID > 1969 & yearID < 2017)
wars <- wars %>% filter(year_ID > 1969)
wars <- wars %>% rename(playerID=player_ID,yearID=year_ID,teamID=team_ID)

salaries <- salaries[order(salaries$playerID,salaries$yearID),]
wars <- wars[order(wars$playerID,wars$yearID),]

#Determine salary bumps/reductions in WAR dataset
players <- unique(wars$playerID)
wars$salary[which(wars$salary=="NULL")] <- "-999"
wars$salary <- as.numeric(wars$salary)

wars$bump = 0
wars$cut = 0
wars$dsal = 0

wars$WAA = as.numeric(wars$WAA)
wars$WAA_off = as.numeric(wars$WAA_off)
wars$WAA_def = as.numeric(wars$WAA_def)
wars$WAR = as.numeric(wars$WAR)
wars$WAR_off = as.numeric(wars$WAR_off)
wars$WAR_def = as.numeric(wars$WAR_def)

player1 <- wars$playerID[[1]]
for (i in 2:nrow(wars)) {
  if (wars$playerID[[i]] == player1){
    wars$prevWAA[[i]] = wars$WAA[[i-1]]
    wars$dWAA[[i]] = wars$WAA[[i]] - wars$WAA[[i-1]]
    wars$prevWAA_off[[i]] = wars$WAA_off[[i-1]]
    wars$dWAA_off[[i]] = wars$WAA_off[[i]] - wars$WAA_off[[i-1]]
    wars$prevWAA_def[[i]] = wars$WAA_def[[i-1]]
    wars$dWAA_def[[i]] = wars$WAA_def[[i]] - wars$WAA_def[[i-1]]
    
    wars$prevWAR[[i]] = wars$WAR[[i-1]]
    wars$dWAR[[i]] = wars$WAR[[i]] - wars$WAR[[i-1]]
    wars$prevWAR_off[[i]] = wars$WAR_off[[i-1]]
    wars$dWAR_off[[i]] = wars$WAR_off[[i]] - wars$WAR_off[[i-1]]
    wars$prevWAR_def[[i]] = wars$WAR_def[[i-1]]
    wars$dWAR_def[[i]] = wars$WAR_def[[i]] - wars$WAR_def[[i-1]]
    
    if (wars$salary[[i]]==-999){
      wars$salary[[i]]=wars$salary[[i-1]]
    }
    #bump if salary increased
    if (wars$salary[[i]] > wars$salary[[i-1]]){
      wars$bump[[i]] = 1
    }
    #cut if salary decreased
    else if (wars$salary[[i]] < wars$salary[[i-1]]){
      wars$cut[[i]] = 1
    }
    wars$dsal[[i]] = wars$salary[[i]] - wars$salary[[i-1]]
    wars$pdsal[[i]] = (wars$salary[[i]] - wars$salary[[i-1]])/wars$salary[[i-1]]
  }
  else{
    player1 <- wars$playerID[[i]]
    if (wars$salary[[i]]==-999){
      wars$salary[[i]]=0
    }
  }
}

setwd("/Users/Chris/Dropbox/School Stuff/BST 260 Data Science/baseball2017")
write.csv(wars,"warplus.csv")
```

```{r,echo=FALSE,eval=FALSE}
# Add salary and other numbers to WAR (for pitchers) table 
1 = 1 #prevent running accidentally since this takes a while to run

library(tidyverse)
setwd("/Users/Chris/Dropbox/School Stuff/BST 260 Data Science/baseball2017/war_archive-2017-11-08")
wars <- read.csv("war_daily_pitch.csv",stringsAsFactors=FALSE)
setwd("/Users/Chris/Dropbox/School Stuff/BST 260 Data Science/baseball2017")
salaries <- read.csv("Salaries.csv",stringsAsFactors=FALSE)

salaries <- salaries %>% filter(yearID > 1969 & yearID < 2017)
wars <- wars %>% filter(year_ID > 1969)
wars <- wars %>% rename(playerID=player_ID,yearID=year_ID,teamID=team_ID)

salaries <- salaries[order(salaries$playerID,salaries$yearID),]
wars <- wars[order(wars$playerID,wars$yearID),]

#Determine salary bumps/reductions in WAR dataset
players <- unique(wars$playerID)
wars$salary[which(wars$salary=="NULL")] <- "-999"
wars$salary <- as.numeric(wars$salary)

wars$bump = 0
wars$cut = 0
wars$dsal = 0

wars$WAA = as.numeric(wars$WAA)
wars$WAR = as.numeric(wars$WAR)

player1 <- wars$playerID[[1]]
for (i in 2:nrow(wars)) {
  if (wars$playerID[[i]] == player1){
    wars$prevWAA[[i]] = wars$WAA[[i-1]]
    wars$dWAA[[i]] = wars$WAA[[i]] - wars$WAA[[i-1]]
    
    wars$prevWAR[[i]] = wars$WAR[[i-1]]
    wars$dWAR[[i]] = wars$WAR[[i]] - wars$WAR[[i-1]]
    
    if (wars$salary[[i]]==-999){
      wars$salary[[i]]=wars$salary[[i-1]]
    }
    #bump if salary increased
    if (wars$salary[[i]] > wars$salary[[i-1]]){
      wars$bump[[i]] = 1
    }
    #cut if salary decreased
    else if (wars$salary[[i]] < wars$salary[[i-1]]){
      wars$cut[[i]] = 1
    }
    wars$dsal[[i]] = wars$salary[[i]] - wars$salary[[i-1]]
    wars$pdsal[[i]] = (wars$salary[[i]] - wars$salary[[i-1]])/wars$salary[[i-1]]
  }
  else{
    player1 <- wars$playerID[[i]]
    if (wars$salary[[i]]==-999){
      wars$salary[[i]]=0
    }
  }
}

setwd("/Users/Chris/Dropbox/School Stuff/BST 260 Data Science/baseball2017")
write.csv(wars,"warpitchplus.csv")
```

```{r,echo=FALSE,warning=FALSE}
library(tidyverse)
setwd("/Users/Chris/Dropbox/School Stuff/BST 260 Data Science/baseball2017")
wars <- read.csv("warplus.csv",stringsAsFactors=FALSE)
names <- read.csv("Teams.csv",stringsAsFactors=FALSE)

names <- names %>% select(yearID,teamID,teamIDBR,teamIDlahman45,teamIDretro,franchID,W,L,Rank)
names <- names %>% filter(yearID>1984 & yearID<2017)
```

```{r,echo=FALSE,warning=FALSE}
wars <- wars %>% filter(yearID>1984 & yearID<2017)
wars$OPS_plus <- as.numeric(wars$OPS_plus)
wars$WAR <- as.numeric(wars$WAR)
wars$WAR_off <- as.numeric(wars$WAR_off)

warteam <- wars %>% na.omit() %>% group_by(yearID,teamID) %>% 
  summarize(medOPS = median(OPS_plus),
            q90OPS = quantile(OPS_plus,0.9),
            q75OPS = quantile(OPS_plus,0.75),
            q25OPS = quantile(OPS_plus,0.25),
            q10OPS = quantile(OPS_plus,0.1),
            sdOPS = sd(OPS_plus),
            medWAR = median(WAR),
            q90WAR = quantile(WAR,0.9),
            q75WAR = quantile(WAR,0.75),
            q25WAR = quantile(WAR,0.25),
            q10WAR = quantile(WAR,0.1),
            sdWAR = sd(WAR),
            medWAR_off = median(WAR_off),
            q90WAR_off = quantile(WAR_off,0.9),
            q75WAR_off = quantile(WAR_off,0.75),
            q10WAR_off = quantile(WAR_off,0.1),
            WARtot = sum(WAR),
            salteam = sum(salary))

warteam %>% ggplot(aes(yearID,medWAR,fill=factor(yearID))) + 
  geom_boxplot(na.rm = TRUE) + theme(legend.position="none") + 
  scale_x_continuous(breaks = seq(1985,2015,5)) + 
  labs(title = "Wins above average",y = "Median WAR (by team)")

```

We can see that WAR variance decreases over time, and stays low after 1996. This could be due to the revenue-sharing agreements, or perhaps due to teams being better about picking players. Regardless, it would seem that the post-strike era is more competitive than before the strike. Let's explore this further.

```{r,echo=FALSE}
warteam$franchID = ""
warteam$wlratio = 0
warteam$rank = 0
warteam$wpct = 0
for (i in 1:nrow(warteam)){
  nameyear <- names %>% filter(yearID==warteam$yearID[[i]])
  nameab <- nameyear %>% filter(nameyear$teamIDBR==warteam$teamID[[i]])
  warteam$franchID[[i]] = nameab$franchID[[1]]
  warteam$wlratio[[i]] = nameab$W[[1]]/nameab$L[[1]]
  warteam$wpct[[i]] = nameab$W[[1]]/(nameab$W[[1]]+nameab$L[[1]])
  warteam$rank[[i]] = nameab$Rank[[1]]
}

#order franchises by total WAR prior to the year 2000
allwar <- warteam %>% filter(yearID<2000)
allwar <- allwar %>% group_by(franchID) %>% summarize(wartot=sum(medWAR))
allwar <- allwar %>% arrange(wartot) #ascending
#allwar <- allwar %>% arrange(desc(wartot)) #descending
allwar$rank <- c(1:nrow(allwar))
allwar$franfct <- allwar$rank
allwar$franfct <- factor(allwar$franfct,levels=allwar$rank,labels=allwar$franchID)

warteam$franfct <- allwar$franfct[[1]]
for (i in 1:nrow(warteam)){
  warteam$franfct[[i]] <- allwar$franfct[which(allwar$franchID==warteam$franchID[[i]])]
}
```

First, let's look at median WAR by team, sorted by summed WAR prior to the year 2000.

```{r,echo=FALSE}
warteam %>% ggplot() + geom_tile(aes(x=yearID,y=factor(franfct),fill=medWAR)) + 
  scale_x_continuous(breaks = seq(1985,2015,5)) + 
  #scale_y_discrete(labels = rev(allwar$franchID)) +
  scale_fill_gradient(low="#00007F", high="red", name="WAR") +
  geom_vline(aes(xintercept=1994),linetype=3,size=1, color="white") +
  labs(title="Median WAR by team",x="Year",y="Team/Franchise")
```

From the heat map, it seems that the teams that consistently had better players before the strike (marked by the dotted white line) lost that advantage after the strike. Let's look at the better players (75th percentile) in each team.

```{r,echo=FALSE}
warteam %>% ggplot() + geom_tile(aes(x=yearID,y=factor(franfct),fill=q75WAR)) + 
  scale_x_continuous(breaks = seq(1985,2015,5)) + 
  #scale_y_discrete(labels = rev(allwar$franchID)) +
  scale_fill_gradient(low="#00007F", high="red", name="WAR") +
  geom_vline(aes(xintercept=1994),linetype=3,size=1, color="white") +
  labs(title="75 percentile WAR by team",x="Year",y="Team/Franchise")
```

The change is less evident here. Let's see if this affected team performance.

```{r,echo=FALSE}
warteam %>% ggplot() + geom_tile(aes(x=yearID,y=factor(franfct),fill=wpct)) + 
  scale_x_continuous(breaks = seq(1985,2015,5)) + 
  #scale_y_discrete(labels = rev(allwar$franchID)) +
  scale_fill_gradient(low="#00007F", high="red", name="Win\nPercentage") +
  geom_vline(aes(xintercept=1994),linetype=3,size=1, color="white") +
  labs(title="Win percentage by team",x="Year",y="Team/Franchise")
```

There is no disernable pattern here. No team is overly dominant in the league, either before or after the strike. Case in point: Houston, which above is visibly the worst team between 2010-2015, just won the World Series.

What kind of players were paid more? Let's look at the year 1995.

```{r,warning=FALSE,echo=FALSE,message=FALSE}
salmax95 <- salaries %>% filter(yearID==1995) %>% select(playerID,teamID,salary) %>% na.omit() %>% group_by(teamID) %>% filter(salary == max(salary))
salmax95 <- unique(salmax95)

setwd("/Users/Chris/Dropbox/School Stuff/BST 260 Data Science/baseball2017")
players <- read.csv("Master.csv",stringsAsFactors=FALSE)
playernames <- players %>% filter(playerID %in% salmax95$playerID) %>% select(playerID,nameFirst,nameLast)
salmax95 <- merge(salmax95,playernames,by="playerID")
salmax95$fullname <- with(salmax95, paste0(nameFirst," ",nameLast))
salmax95 <- salmax95[order(salmax95$salary),]

#salmax95 %>% summarize(Name = fullname, Team = teamID, Salary = salary)

library(ggrepel)
salmax95 %>% ggplot(aes(x=1995,y=salary/1000000,label=nameFirst)) +
  geom_text_repel(aes(label=fullname),segment.color = 'grey3',segment.alpha=0.25,label.padding=1.5) + 
  geom_point(aes(color=salary/1000000)) +
  scale_color_gradientn(colors = rainbow(5),breaks=seq(0,10,2),name="Percent") +
  scale_x_continuous(breaks=c()) +
  labs(title="Highest-paid players per team, 1995",x="",y = "Salary ($, millions)")
```

The above visualization sounded like a better idea than it turned out to be. Let's look at a table instead.

```{r,echo=FALSE}
for (i in 1:nrow(revs)) {
  revs$TID[[i]] = names$teamID[which(names$yearID==revs$Year[[i]] & names$franchID==revs$franchID[[i]])]
}
for (i in 1:nrow(salmax95)) {
  salmax95$teamname[[i]] <- revs$Team[which(revs$Year==1995 & revs$TID==salmax95$teamID[[i]])]  
}
salmax95$teamname <- as.character(salmax95$teamname)
salmax95 <- salmax95 %>% mutate(salchr = paste("$",round(salary/100000)/10,sep=""))
salmax95 %>% select(fullname,teamname,salchr) %>% rename(Name=fullname,Team=teamname,Salary=salchr) %>% arrange(desc(Salary))
```

The max salaries for each team went to future Hall of Famers Ken Griffey Jr., Barry Larkin, Kirby Puckett, and Cal Ripken, Jr., as well as other popular players of the time, including Barry Bonds, Jose Canseco, Mark McGwire, and Daryl Strawberry. So, it seems that salaries went to popular players, who were presumably also the players who played well.

Here's a word cloud, with sizes/color corresponding to salary:

```{r,echo=FALSE}
library(ggrepel)
salmax95 %>% ggplot() +
  aes(x=1,y=1,size=salary,color=salary,label=fullname) +
  geom_text_repel(segment.size=0, force=100,nudge_x = 1,nudge_y = 0.25) + 
  scale_color_gradientn(colors=c("#00007F","skyblue","orange","red"),breaks=seq(0,10,2)) +
  scale_x_continuous(breaks=c()) +
  theme(axis.line=element_blank(), axis.text.y=element_blank(), axis.ticks=element_blank(), panel.background = element_blank(), panel.grid.major = element_blank()) +
  scale_size(range = c(4, 8), guide = FALSE) +
  labs(title="",x="",y = "")
```

Moving on.

###Money vs. Performance

[Note that I left in a lot of data exploration in this section, so it will be a bit messier than above.]

Do better players make more? Let's first look at how WAR may have influenced changes in salary.

```{r}
#Previously calculated salary changes and performance changes year-to-year and saved in warplus.csv
warstats <- wars %>% filter(pitcher=="N")
#warstats <- wars
warstats <- warstats[c("playerID","yearID","teamID",
                       "WAA","WAA_off","WAA_def",
                       "WAR","WAR_off","WAR_def",
                       "prevWAA","prevWAA_off","prevWAA_def",
                       "prevWAR","prevWAR_off","prevWAR_def",
                       "dWAA","dWAA_off","dWAA_def",
                       "dWAR","dWAR_off","dWAR_def",
                       "OPS_plus","salary","bump","cut","dsal","pdsal")]
warstats <- warstats %>% filter(yearID > 1985)

warstats <- warstats %>% filter(dsal!=0)
warstats <- warstats %>% filter(abs(dsal)>1)

warcut <- warstats %>% filter(dsal<0)
warcut %>% ggplot() + geom_histogram(aes(as.numeric(prevWAR)),binwidth=0.05) +
  labs(title="Players who received a salary decrease",x="Wins Above Replacement")

warbump <- warstats %>% filter(dsal>0)
warbump %>% ggplot() + geom_histogram(aes(as.numeric(prevWAR)),binwidth=0.05) +
  labs(title="Players who received a salary increase",x="Wins Above Replacement")
```


All of the performance stats (including Wins Above Average (WAA), offensive and defensive stats, and previous and current performance/salary) listed in the above chunk of code were tested. No obvious trend was there. Let's look at other trends.


```{r,message=FALSE}
warstats$pdsal[which(warstats$pdsal==Inf)] = NA

warstats %>% filter(pdsal < 40, dsal > -100000) %>% ggplot() + 
  geom_point(aes(prevWAA_off,dsal + abs(min(dsal))+1 )) +
  geom_smooth(aes(prevWAA_off,dsal + abs(min(dsal))+1 )) +
  scale_y_continuous(trans="log10") +
  labs(x="WAA in previous year", y="Salary change ($, log millions)")

warstats %>% ggplot() + 
  geom_point(aes(prevWAA_off,dsal/1000000)) +
  geom_smooth(aes(prevWAA_off,dsal/1000000)) +
  scale_y_continuous(breaks=seq(-30,30,5)) +
  labs(x="WAA in previous year", y="Salary change ($, millions)")

warstats %>% ggplot() + 
  geom_point(aes(prevWAR_off,dsal/1000000)) +
  geom_smooth(aes(prevWAR_off,dsal/1000000)) +
  scale_y_continuous(breaks=seq(-30,30,5)) +
  labs(x="WAR in previous year", y="Salary change ($, millions)")

warstats %>% ggplot() + 
  geom_point(aes(prevWAR,salary/1000000)) +
  geom_smooth(aes(prevWAR,salary/1000000)) +
  scale_y_continuous(breaks=seq(-30,30,5)) +
  labs(x="WAR in previous year", y="Current salary ($, millions)")

```


There may be an increasing trend. Let's look at a regression.


```{r}
summary(lm(warstats$salary~warstats$prevWAR))
```


There is a significant effect, but the R-squared is not convincing. What about for a single year?


```{r,message=FALSE,warning=FALSE}
warstats %>% filter(yearID==1991) %>% ggplot() + 
  geom_point(aes(prevWAR,salary/1000000)) +
  geom_smooth(aes(prevWAR,salary/1000000)) +
  scale_y_continuous(breaks=seq(-30,30,5),trans="log10") +
  labs(x="WAR in previous year", y="Salary change ($, millions)")
```

```{r}
w2 <- warstats %>% filter(yearID==1991)
summary(lm(w2$dsal~w2$prevWAR))
```


Sure enough, this looks a bit more convincing. Let's look at this over several years.


```{r,echo=FALSE}
w2 <- warstats

library(broom)
regres <- w2 %>% group_by(yearID) %>% do(glance(lm(salary ~ prevWAR,data=.)))

regres %>% ggplot() + geom_bar(aes(yearID,adj.r.squared,fill=adj.r.squared),stat="identity") +
    scale_x_continuous(limits = c(1984,2016), breaks=seq(1985,2015,5)) +
    scale_fill_distiller(palette = "Spectral",breaks=seq(0,70,20),name="Percent") +
    geom_text(aes(x=1994,y=0.02),label="STRIKE",angle=90,hjust = 0,color="white") +
    geom_text(aes(x=1986,y=.5),label="CBA6",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=1990.5,y=.5),label="CBA7",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=1997,y=.5),label="CBA8",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=2003,y=.5),label="CBA9",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=2007.2,y=.5),label="CBA10",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=2012,y=.5),label="CBA11",hjust = 0,color="black",size=3.5) +
    geom_vline(aes(xintercept=1989.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=1993.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=1994.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=2001.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=2006.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=2010.5),linetype=3, color="black") +
    labs(title="Correlation between previous year's WAR and current salary",x="Year",y="Adjusted R-squared")
```

```{r,echo=FALSE}
addcba <- function(df){
  df$cba = .bincode(df$yearID,c(0,1993.5,1994.5,2002,2006,2010,10000))
  df$cba = ifelse(df$cba>2,df$cba+5,df$cba)
  df$cba = ifelse(df$cba==1,df$cba+6,df$cba)
  df$cba = ifelse(df$cba==2,NA,df$cba)
  df
}

regres <- addcba(regres)

anova.reg <- aov(adj.r.squared ~ as.factor(cba),data=regres)
summary(anova.reg)
TukeyHSD(anova.reg)
```


We see that the correlation between current salary and WAR in the previous year changes over time, with greater correlation during CBA6-CBA9, and less thereafter.


```{r,echo=FALSE}
w2 <- warstats

library(broom)
regres <- w2 %>% group_by(yearID) %>% do(glance(lm(salary ~ WAR,data=.)))

regres %>% ggplot() + geom_bar(aes(yearID,adj.r.squared,fill=adj.r.squared),stat="identity") +
    scale_x_continuous(limits = c(1984,2016), breaks=seq(1985,2015,5)) +
    scale_fill_distiller(palette = "Spectral",breaks=seq(0,70,20),name="Percent") +
    geom_text(aes(x=1994,y=0.02),label="STRIKE",angle=90,hjust = 0,color="white") +
    geom_text(aes(x=1986,y=.4),label="CBA6",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=1990.5,y=.4),label="CBA7",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=1997,y=.4),label="CBA8",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=2003,y=.4),label="CBA9",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=2007.2,y=.4),label="CBA10",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=2012,y=.4),label="CBA11",hjust = 0,color="black",size=3.5) +
    geom_vline(aes(xintercept=1989.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=1993.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=1994.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=2001.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=2006.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=2010.5),linetype=3, color="black") +
    labs(title="Correlation between WAR and salary in the same year",x="Year",y="Adjusted R-squared")
```

```{r,echo=FALSE}
regres <- addcba(regres)

anova.reg <- aov(adj.r.squared ~ as.factor(cba),data=regres)
summary(anova.reg)
TukeyHSD(anova.reg)
```


Looking at salary and performance within the same year, we see that the highest correlation was during CBA8, though there were significant differences between periods.

Why would this correlation change with the collective bargaining agreements? Perhaps it had to do with luxury tax. Or perhaps teams simply got better at paying players less. Perhaps WAR doesn't tell the whole story.

Now let's look at how salary may have affected team performances, in successive five-year periods. First, win percentage against salary, with salary standardized by year.


```{r,echo=FALSE}
salteam2 <- left_join(salteam,names,by=c("teamID","yearID"))
salteam2 <- salteam2 %>% mutate(wlratio = W/L, wpct = W/(W+L))
salteam3 <- salteam2 %>% group_by(yearID) %>% 
  mutate(muavgy = mean(avgsal),sdavgy = sd(avgsal),
         mutoty = mean(totsal),sdtoty = sd(totsal),
         wpd = totsal/W)
cpi2 <- cpi %>% rename(yearID = year)
salteam4 <- merge(salteam3,cpi2,by="yearID")
salteam4 <- salteam4 %>% mutate(wpd1990 = wpd/v1900)

#wlres <- salteam2 %>% group_by(yearID) %>% do(tidy(lm(wlratio ~ totsal,data=.)))
wlres <- salteam2 %>% group_by(yearID) %>% do(glance(lm(wlratio ~ p50sal,data=.)))
```

```{r,warning=FALSE,message=FALSE}
#yearly standard
require(gridExtra)
date1 = seq(1985,2010,5)
date2 = seq(1989,2014,5)
dates = data.frame(date1,date2)
plots = list()

for(i in 1:6){
  tmpsal <- salteam3 %>% filter(yearID > dates$date1[[i]] & yearID <= dates$date2[[i]])
  tmpsal <- tmpsal %>% mutate(stdsal = (totsal - mutoty)/sdtoty)
  wlres <- tmpsal %>% lm(wpct ~ stdsal,data=.)
  print(summary(wlres))
  label = paste(dates$date1[[i]],dates$date2[[i]],sep="-")
  myplot <- tmpsal %>% ggplot() + geom_point(aes(stdsal,wpct)) + geom_smooth(aes(stdsal,wpct)) + labs(title=label,x="Standardized Salary",y="Win Percentage")
  newvar = paste("myplot",i,sep="")
  assign(newvar,myplot)
  #print(myplot)
}

grid.arrange(myplot1,myplot2,myplot3,myplot4,myplot5,myplot6,ncol=3)
```


Next, win percentage against salary, with salary standardized over each 5-year period.


```{r,warning=FALSE,message=FALSE}
#5 year standard
date1 = seq(1985,2010,5)
date2 = seq(1989,2014,5)
dates = data.frame(date1,date2)

for(i in 1:6){
  tmpsal <- salteam2 %>% filter(yearID > dates$date1[[i]] & yearID <= dates$date2[[i]])
  meansdsal <- tmpsal %>% summarize(meansal = mean(totsal), sdsal = sd(totsal))
  tmpsal <- tmpsal %>% mutate(stdsal = (totsal - meansdsal$meansal)/meansdsal$sdsal)
  wlres <- tmpsal %>% lm(wpct ~ stdsal,data=.)
  print(summary(wlres))
  label = paste(dates$date1[[i]],dates$date2[[i]],sep="-")
  myplot <- tmpsal %>% ggplot() + geom_point(aes(stdsal,wpct)) + geom_smooth(aes(stdsal,wpct)) + labs(title=label,x="Standardized Salary",y="Win Percentage")
  newvar = paste("myplot",i,sep="")
  assign(newvar,myplot)
  #print(myplot)
}

grid.arrange(myplot1,myplot2,myplot3,myplot4,myplot5,myplot6,ncol=3)
```


Next, league rank against salary, with salary standardized over each 5-year period.


```{r,warning=FALSE,message=FALSE}

date1 = seq(1985,2010,5)
date2 = seq(1989,2014,5)
dates = data.frame(date1,date2)

for(i in 1:6){
  tmpsal <- salteam2 %>% filter(yearID > dates$date1[[i]] & yearID <= dates$date2[[i]])
  meansdsal <- tmpsal %>% summarize(meansal = mean(totsal), sdsal = sd(totsal))
  tmpsal <- tmpsal %>% mutate(stdsal = (totsal - meansdsal$meansal)/meansdsal$sdsal)
  wlres <- tmpsal %>% lm(Rank ~ stdsal,data=.)
  print(summary(wlres))
  label = paste(dates$date1[[i]],dates$date2[[i]],sep="-")
  myplot <- tmpsal %>% ggplot() + geom_point(aes(stdsal,Rank)) + geom_smooth(aes(stdsal,Rank)) + labs(title=label,x="Standardized Salary",y="Rank")
  newvar = paste("myplot",i,sep="")
  assign(newvar,myplot)
  #print(myplot)
}

grid.arrange(myplot1,myplot2,myplot3,myplot4,myplot5,myplot6,ncol=3)

```


Next, win-loss ratio against salary, with salary standardized over each 5-year period.


```{r,warning=FALSE,message=FALSE}
#yearly standard
date1 = seq(1985,2010,5)
date2 = seq(1989,2014,5)
dates = data.frame(date1,date2)

for(i in 1:6){
  tmpsal <- salteam3 %>% filter(yearID > dates$date1[[i]] & yearID <= dates$date2[[i]])
  tmpsal <- tmpsal %>% mutate(stdsal = (totsal - mutoty)/sdtoty)
  wlres <- tmpsal %>% lm(wlratio ~ stdsal,data=.)
  print(summary(wlres))
  label = paste(dates$date1[[i]],dates$date2[[i]],sep="-")
  myplot <- tmpsal %>% ggplot() + geom_point(aes(stdsal,wlratio)) + geom_smooth(aes(stdsal,wlratio)) + labs(title=label,x="Standardized Salary",y="Win-Loss Ratio")
  newvar = paste("myplot",i,sep="")
  assign(newvar,myplot)
  #print(myplot)
}

grid.arrange(myplot1,myplot2,myplot3,myplot4,myplot5,myplot6,ncol=3)

```


The above analyses seem to indicate better win rates and ranks (with 1 being best) as more money is spent. The correlations vary by period, however, so let's do another year-by-year breakdown.

```{r,echo=FALSE}
tmpsal <- salteam3 %>% mutate(stdsal = (totsal - mutoty)/sdtoty)
reg_totsal <- tmpsal %>% group_by(yearID) %>% do(glance(lm(wpct ~ stdsal,data=.)))
#reg_totsal

tmpsal <- salteam3 %>% mutate(stdsal = (avgsal - muavgy)/sdavgy)
reg_avgsal <- tmpsal %>% group_by(yearID) %>% do(glance(lm(wpct ~ stdsal,data=.)))
#reg_avgsal

tmpsal <- salteam3 %>% mutate(stdsal = (avgsal - muavgy)/sdavgy)
reg_avgsal2 <- tmpsal %>% group_by(yearID) %>% do(tidy(lm(wpct ~ stdsal,data=.)))
reg_avgsal2 <- reg_avgsal2 %>% filter(term=="stdsal")
#reg_avgsal2

tmpsal <- salteam3 %>% mutate(stdsal = (avgsal - muavgy)/sdavgy)
reg_avgsal3a <- tmpsal %>% group_by(yearID) %>% do(tidy(lm(Rank ~ stdsal,data=.)))
reg_avgsal3a <- reg_avgsal3a %>% filter(term=="stdsal")
#reg_avgsal3a

tmpsal <- salteam3 %>% mutate(stdsal = (avgsal - muavgy)/sdavgy)
reg_avgsal3b <- tmpsal %>% group_by(yearID) %>% do(glance(lm(Rank ~ stdsal,data=.)))
#reg_avgsal3b
```


```{r,echo=FALSE}
reg_totsal %>% ggplot() + geom_bar(aes(yearID,adj.r.squared,fill=adj.r.squared),stat="identity") +
    scale_x_continuous(limits = c(1984,2016), breaks=seq(1985,2015,5)) +
    scale_fill_distiller(palette = "Spectral",breaks=seq(0,70,20),name="Percent") +
    geom_text(aes(x=1994,y=0.02),label="STRIKE",angle=90,hjust = 0,color="red") +
    geom_text(aes(x=1986,y=.5),label="CBA6",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=1990.5,y=.5),label="CBA7",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=1997,y=.5),label="CBA8",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=2003,y=.5),label="CBA9",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=2007.2,y=.5),label="CBA10",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=2012,y=.5),label="CBA11",hjust = 0,color="black",size=3.5) +
    geom_vline(aes(xintercept=1989.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=1993.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=1994.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=2001.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=2006.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=2010.5),linetype=3, color="black") +
    theme(legend.position="none") +
    labs(title="Correlation of standardized total salary and win percentage by year",
         x="Year",y="Adjusted R-squared")
```


```{r,echo=FALSE}
reg_avgsal %>% ggplot() + geom_bar(aes(yearID,adj.r.squared,fill=adj.r.squared),stat="identity") +
    scale_x_continuous(limits = c(1984,2016), breaks=seq(1985,2015,5)) +
    scale_fill_distiller(palette = "Spectral",breaks=seq(0,70,20),name="Percent") +
    geom_text(aes(x=1994,y=0.02),label="STRIKE",angle=90,hjust = 0,color="red",size=4) +
    geom_text(aes(x=1986,y=.5),label="CBA6",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=1990.5,y=.5),label="CBA7",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=1997,y=.5),label="CBA8",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=2003,y=.5),label="CBA9",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=2007.2,y=.5),label="CBA10",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=2012,y=.5),label="CBA11",hjust = 0,color="black",size=3.5) +
    geom_vline(aes(xintercept=1989.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=1993.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=1994.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=2001.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=2006.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=2010.5),linetype=3, color="black") +
    theme(legend.position="none") +
    labs(title="Correlation of average salary and win percentage by year",
         x="Year",y="Adjusted R-squared")
```

Average salary seems to have a greater effect than total salary, though both have similar trends. The greatest correlation is during CBA8. Let's see about the effect.

```{r,echo=FALSE}
ytext = 7
reg_avgsal2 %>% ggplot() + geom_bar(aes(yearID,estimate*100,fill=estimate),stat="identity") +
    scale_x_continuous(limits = c(1984,2016), breaks=seq(1985,2015,5)) +
    scale_fill_distiller(palette = "Spectral",breaks=seq(0,70,20),name="Percent") +
    geom_text(aes(x=1994,y=0.25),label="STRIKE",angle=90,hjust = 0,color="red",size=4) +
    geom_text(aes(x=1986,y=ytext),label="CBA6",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=1990.5,y=ytext),label="CBA7",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=1997,y=ytext),label="CBA8",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=2003,y=ytext),label="CBA9",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=2007.2,y=ytext),label="CBA10",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=2012,y=ytext),label="CBA11",hjust = 0,color="black",size=3.5) +
    geom_vline(aes(xintercept=1989.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=1993.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=1994.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=2001.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=2006.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=2010.5),linetype=3, color="black") +
    theme(legend.position="none") +
    labs(title="Effect of average salary on win percentage by year",
         x="Year",y="% change for 1 SD increase in avg. salary")
```

Even at its greatest, the effect is relatively small, with about a 4 percent increase in win percentage for a 1 standard deviation increase in average salary in a given year. How about league rank?

```{r,echo=FALSE}
ytext = 1.1
reg_avgsal3a %>% ggplot() + geom_bar(aes(yearID,-estimate,fill=-estimate),stat="identity") +
    scale_x_continuous(limits = c(1984,2016), breaks=seq(1985,2015,5)) +
    scale_fill_distiller(palette = "Spectral",breaks=seq(0,70,20),name="Percent") +
    geom_text(aes(x=1994,y=0.05),label="STRIKE",angle=90,hjust = 0,color="red",size=4) +
    geom_text(aes(x=1986,y=ytext),label="CBA6",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=1990.5,y=ytext),label="CBA7",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=1997,y=ytext),label="CBA8",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=2003,y=ytext),label="CBA9",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=2007.2,y=ytext),label="CBA10",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=2012,y=ytext),label="CBA11",hjust = 0,color="black",size=3.5) +
    geom_vline(aes(xintercept=1989.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=1993.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=1994.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=2001.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=2006.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=2010.5),linetype=3, color="black") +
    theme(legend.position="none") +
    labs(title="Effect of average salary on rank by year",
         x="Year",y="Increase in rank for a 1 SD increase in avg. salary")
```

The effect size is similarly underwhelming, with a maximum of a ~0.9 increase in league rank for every standard deviation increase in average salary.

```{r,echo=FALSE}
ytext = 0.45
reg_avgsal3b %>% ggplot() + geom_bar(aes(yearID,adj.r.squared,fill=adj.r.squared),stat="identity") +
    scale_x_continuous(limits = c(1984,2016), breaks=seq(1985,2015,5)) +
    scale_fill_distiller(palette = "Spectral",breaks=seq(0,70,20),name="Percent") +
    geom_text(aes(x=1994,y=0.02),label="STRIKE",angle=90,hjust = 0,color="red",size=4) +
    geom_text(aes(x=1986,y=ytext),label="CBA6",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=1990.5,y=ytext),label="CBA7",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=1997,y=ytext),label="CBA8",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=2003,y=ytext),label="CBA9",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=2007.2,y=ytext),label="CBA10",hjust = 0,color="black",size=3.5) +
    geom_text(aes(x=2012,y=ytext),label="CBA11",hjust = 0,color="black",size=3.5) +
    geom_vline(aes(xintercept=1989.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=1993.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=1994.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=2001.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=2006.5),linetype=3, color="black") +
    geom_vline(aes(xintercept=2010.5),linetype=3, color="black") +
    theme(legend.position="none") +
    labs(title="Correlation of average salary and rank by year",x="Year",y="Adjusted R-squared")
```

The correlation between average salary and spending is generally weak, with most adjusted R-squared values below 0.1.

Overall, the effect of spending more money seems to be small, but perhaps those small margins, combined with other management factors, are enough to translate into a competitive advantage, however transient.

###Conclusion

In summary, we have seen that: <br />
(1) Player salaries have increased over time, but the top rates have done so faster than the lower ones. <br />
(2) Financial measures taken following the 1994 strike and in successive CBAs seem to have stabilized revenue streams for individual franchises and the overall growth of the league. <br />
(3) Teams that were previously dominant on paper are less so today, but Major League Baseball remains as competitive as ever. <br />
(4) Paying more money has a small effect on player and team performance, which has decreased over time.


